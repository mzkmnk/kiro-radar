# 設計書: Spec ファイルパーサー

## 概要

Markdown で記述された Spec ファイルを解析し、タスク情報と進捗データを抽出するパーサーを実装します。Rust の標準ライブラリと正規表現を使用したシンプルな実装を目指します。

## アーキテクチャ

### モジュール構成

```
src/spec/
├── mod.rs          # モジュール定義
├── parser.rs       # Markdownパーサー
└── finder.rs       # ファイル検索
```

### データフロー

```
ファイルシステム → ファイル読み込み → Markdown解析 → データ構造 → 進捗計算
```

## コンポーネントとインターフェース

### Task 構造体

タスク情報を表現するデータ構造：

```rust
pub struct Task {
    pub title: String,
    pub completed: bool,
    pub level: usize,  // インデントレベル
}
```

### SpecParser

Markdown 解析の責務を持つ：

```rust
pub struct SpecParser;

impl SpecParser {
    pub fn parse_tasks(content: &str) -> Vec<Task>;
    pub fn calculate_progress(tasks: &[Task]) -> f32;
}
```

### ファイル読み込み

標準ライブラリの `std::fs` を使用：

```rust
pub fn read_spec_file(path: &Path) -> Result<String, std::io::Error>;
```

## データモデル

### Task

- `title`: タスクの説明文
- `completed`: 完了状態（true/false）
- `level`: 階層レベル（0 始まり）

### Progress

- `total`: 総タスク数
- `completed`: 完了タスク数
- `percentage`: 完了率（0.0〜1.0）

## 正確性プロパティ

_プロパティは、システムのすべての有効な実行において真であるべき特性や動作です。これは人間が読める仕様と機械検証可能な正確性保証の橋渡しとなります。_

### プロパティ 1: ファイル読み込みの一貫性

*任意の*有効なファイルパスに対して、ファイルを読み込んだ結果の文字列は、そのファイルの実際の内容と一致する

**検証: 要件 1.1**

### プロパティ 2: タスク解析の完全性

*任意の*Markdown テキストに対して、解析されたタスクの数は、元のテキスト内のチェックボックス付きリスト項目の数と等しい

**検証: 要件 2.1**

### プロパティ 3: 完了状態の正確性

*任意の*タスクリストに対して、`[x]`または`[X]`でマークされたタスクは完了として解析され、`[ ]`でマークされたタスクは未完了として解析される

**検証: 要件 2.2, 2.3**

### プロパティ 4: 階層構造の保持

*任意の*ネストされたタスクリストに対して、解析後のタスクのインデントレベルは、元の Markdown のインデント構造を反映する

**検証: 要件 2.4**

### プロパティ 5: 進捗計算の正確性

*任意の*タスクリストに対して、計算された完了タスク数は、completed=true のタスクの数と等しく、総タスク数はリスト内のすべてのタスクの数と等しい

**検証: 要件 3.1**

## エラーハンドリング

### ファイル読み込みエラー

- 存在しないファイル: `std::io::Error` を返す
- 読み込み権限なし: `std::io::Error` を返す
- 空ファイル: 空文字列を正常に返す

### パース エラー

- 不正な Markdown 形式: 無視してスキップ
- 認識できないチェックボックス形式: 無視してスキップ

## テスト戦略

### ユニットテスト

- 空ファイルの読み込み
- 存在しないファイルの読み込み
- 全完了タスクの進捗率（100%）
- 全未完了タスクの進捗率（0%）

### プロパティベーステスト

- **quickcheck** クレートを使用
- 各テストは最低 100 回の反復を実行
- 各プロパティベーステストには、設計書のプロパティ番号を明示的にコメントで記載
- フォーマット: `// Feature: sample-spec-parser, Property X: [プロパティテキスト]`

プロパティテストの対象：

- プロパティ 1: ファイル読み込みの一貫性
- プロパティ 2: タスク解析の完全性
- プロパティ 3: 完了状態の正確性
- プロパティ 4: 階層構造の保持
- プロパティ 5: 進捗計算の正確性

### テストデータ生成

- ランダムな Markdown テキスト生成
- ランダムなタスクリスト生成
- ランダムな階層構造生成
